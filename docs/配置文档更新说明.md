# 配置文档更新说明

## 更新时间
2024-12-13

## 更新内容

### 推荐使用 `Configure[T any]` 模式

在配置管理文档中新增并强烈推荐使用 `Configure[T]` 模式进行配置管理。

## 什么是 Configure[T]？

`Configure[T]` 是 CSGO 提供的优雅配置管理方式，灵感来自 .NET 的 `services.Configure<T>()`。

### 核心特性

1. **类型安全** - 使用 Go 泛型，完全类型安全
2. **自动注入** - 自动注册到 DI 容器
3. **热更新支持** - 配置文件修改后自动更新
4. **两种注入风格** - 支持 `IOptionsMonitor[T]` 和直接注入 `T`
5. **一行代码** - 极简的 API 设计

### 三种变体

#### 1. Configure[T] - 基本用法

```go
configuration.Configure[AppSettings](builder.Services, "app")
```

#### 2. ConfigureWithDefaults[T] - 带默认值

```go
configuration.ConfigureWithDefaults[DatabaseSettings](builder.Services, "database", 
    func() *DatabaseSettings {
        return &DatabaseSettings{
            MaxConnections: 10,
            Timeout:        30,
        }
    },
)
```

#### 3. ConfigureWithValidation[T] - 带验证

```go
configuration.ConfigureWithValidation[EmailSettings](builder.Services, "email",
    func(opts *EmailSettings) error {
        if opts.SmtpHost == "" {
            return fmt.Errorf("SMTP host is required")
        }
        return nil
    },
)
```

## 完整使用示例

### 1. 定义配置结构

```go
type AppSettings struct {
    Name    string `json:"name"`
    Version string `json:"version"`
    Debug   bool   `json:"debug"`
}

type DatabaseSettings struct {
    Host           string `json:"host"`
    Port           int    `json:"port"`
    MaxConnections int    `json:"maxConnections"`
}
```

### 2. 配置文件 (appsettings.json)

```json
{
  "app": {
    "name": "MyApp",
    "version": "1.0.0",
    "debug": true
  },
  "database": {
    "host": "localhost",
    "port": 5432,
    "maxConnections": 100
  }
}
```

### 3. 注册配置

```go
func main() {
    builder := web.CreateBuilder()
    
    // 一行代码注册配置
    configuration.Configure[AppSettings](builder.Services, "app")
    configuration.Configure[DatabaseSettings](builder.Services, "database")
    
    // 注册服务（自动注入配置）
    builder.Services.Add(NewUserService)
    
    app := builder.Build()
    app.Run()
}
```

### 4. 在服务中使用配置

#### 风格 1：IOptionsMonitor（推荐，支持热更新）

```go
type UserService struct {
    dbConfig configuration.IOptionsMonitor[DatabaseSettings]
    logger   logging.ILogger
}

func NewUserService(
    dbConfig configuration.IOptionsMonitor[DatabaseSettings],
    logger logging.ILogger,
) *UserService {
    return &UserService{
        dbConfig: dbConfig,
        logger:   logger,
    }
}

func (s *UserService) Connect() error {
    // CurrentValue() 总是返回最新配置
    config := s.dbConfig.CurrentValue()
    
    connStr := fmt.Sprintf("%s:%d", config.Host, config.Port)
    s.logger.LogInformation("Connecting to: %s", connStr)
    
    // 连接数据库...
    return nil
}

// 可选：监听配置变化
func (s *UserService) WatchConfigChanges() {
    s.dbConfig.OnChange(func(newConfig *DatabaseSettings, name string) {
        s.logger.LogInformation("Database config changed: %s:%d", 
            newConfig.Host, newConfig.Port)
        // 重新连接或更新连接池
    })
}
```

#### 风格 2：直接注入配置值（快照）

```go
type EmailService struct {
    appConfig AppSettings
    logger    logging.ILogger
}

func NewEmailService(
    appConfig AppSettings,  // 直接注入配置值
    logger logging.ILogger,
) *EmailService {
    return &EmailService{
        appConfig: appConfig,
        logger:    logger,
    }
}

func (s *EmailService) SendWelcome(email string) error {
    subject := fmt.Sprintf("Welcome to %s", s.appConfig.Name)
    // 发送邮件...
    return nil
}
```

## 与传统方式对比

### Configure[T] vs 手动绑定

| 特性 | Configure[T] | 手动绑定 |
|------|-------------|---------|
| **代码量** | ✅ 1 行 | ❌ 10+ 行 |
| **类型安全** | ✅ 编译时检查 | ✅ 编译时检查 |
| **热更新** | ✅ 自动支持 | ❌ 需手动实现 |
| **依赖注入** | ✅ 自动注册 | ❌ 需手动注册 |
| **线程安全** | ✅ 自动处理 | ❌ 需手动加锁 |
| **两种注入风格** | ✅ IOptionsMonitor + T | ❌ 只有一种 |
| **配置验证** | ✅ ConfigureWithValidation | ❌ 需手动验证 |
| **默认值** | ✅ ConfigureWithDefaults | ⚠️ 需手动处理 |

### 代码对比

**Configure[T] 方式（推荐）：**

```go
// 注册（1 行）
configuration.Configure[DatabaseSettings](builder.Services, "database")

// 使用（自动获取最新配置）
func (s *Service) DoWork() {
    config := s.dbConfig.CurrentValue()
    // 使用 config...
}
```

**传统方式（不推荐）：**

```go
// 注册（10+ 行）
builder.Services.Add(func(config configuration.IConfiguration) *DatabaseSettings {
    var settings DatabaseSettings
    if err := config.Bind("database", &settings); err != nil {
        log.Fatal(err)
    }
    return &settings
})

// 使用（需要手动刷新配置）
type Service struct {
    config configuration.IConfiguration
    mu     sync.RWMutex
    dbHost string
    dbPort int
}

func (s *Service) reloadConfig() {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.dbHost = s.config.Get("database:host")
    s.dbPort = s.config.GetInt("database:port", 5432)
}

func (s *Service) DoWork() {
    s.mu.RLock()
    host := s.dbHost
    port := s.dbPort
    s.mu.RUnlock()
    // 使用配置...
}
```

## 为什么推荐 Configure[T]？

### 1. 极简 API

```go
// 只需一行代码
configuration.Configure[AppSettings](builder.Services, "app")

// vs 传统方式需要编写工厂函数、错误处理、绑定逻辑...
```

### 2. 自动热更新

```go
// 配置文件修改后，CurrentValue() 自动返回最新值
config := s.dbConfig.CurrentValue()  // 总是最新！

// vs 传统方式需要手动监听、手动刷新、手动加锁...
```

### 3. 类型安全

```go
// 编译时类型检查
var dbConfig configuration.IOptionsMonitor[DatabaseSettings]

// vs 字符串键容易出错
port := config.GetInt("databse:port", 5432)  // 拼写错误！
```

### 4. 两种注入风格

```go
// 风格 1：需要热更新
func NewService(config configuration.IOptionsMonitor[Settings]) *Service

// 风格 2：不需要热更新（快照）
func NewService(config Settings) *Service
```

### 5. 内置验证

```go
// 启动时自动验证
configuration.ConfigureWithValidation[Settings](services, "app",
    func(s *Settings) error {
        if s.Port < 1 {
            return fmt.Errorf("invalid port")
        }
        return nil
    },
)
```

## 更新的文档

### 主要更新

1. **configuration/README.md** - 完整配置文档
   - 新增 "Options 模式（推荐）" 章节
   - 重写 "配置热更新" 章节
   - 更新 "最佳实践" 章节
   - 添加对比表格和完整示例

2. **docs/01-fundamentals/configuration.md** - 基础教程
   - 添加 Configure[T] 快速示例
   - 更新核心内容概览

### 新增内容

- ✅ Configure[T] 完整使用指南
- ✅ 三种变体详细说明（Configure、ConfigureWithDefaults、ConfigureWithValidation）
- ✅ 两种注入风格对比（IOptionsMonitor vs 直接注入）
- ✅ 热更新实现对比
- ✅ 最佳实践更新
- ✅ 完整的代码示例
- ✅ 对比表格

## 开发者指南

### 什么时候使用 Configure[T]？

✅ **推荐使用**：
- 需要强类型配置
- 需要配置热更新
- 需要依赖注入集成
- 构建可复用组件/库
- 生产级应用

⚠️ **可选使用**：
- 简单的脚本或工具
- 只需读取几个配置值
- 不需要热更新

### 什么时候使用直接读取？

```go
port := builder.Configuration.GetInt("server:port", 8080)
```

适用于：
- 应用启动时一次性读取
- 简单的配置值
- 不需要注入到服务中

## 迁移指南

### 从手动绑定迁移到 Configure[T]

**Before:**

```go
type ServerConfig struct {
    Port int    `json:"port"`
    Host string `json:"host"`
}

builder.Services.Add(func(config configuration.IConfiguration) *ServerConfig {
    var cfg ServerConfig
    config.Bind("server", &cfg)
    return &cfg
})
```

**After:**

```go
type ServerConfig struct {
    Port int    `json:"port"`
    Host string `json:"host"`
}

configuration.Configure[ServerConfig](builder.Services, "server")
```

### 从字符串键迁移到 Configure[T]

**Before:**

```go
func (s *Service) DoWork() {
    port := s.config.GetInt("server:port", 8080)
    host := s.config.Get("server:host")
    // ...
}
```

**After:**

```go
type ServerConfig struct {
    Port int    `json:"port"`
    Host string `json:"host"`
}

configuration.Configure[ServerConfig](builder.Services, "server")

func (s *Service) DoWork() {
    config := s.serverConfig.CurrentValue()
    port := config.Port
    host := config.Host
    // ...
}
```

## 与 .NET 的对应关系

| .NET | CSGO |
|------|------|
| `services.Configure<T>(config.GetSection("App"))` | `configuration.Configure[T](services, "App")` |
| `IOptionsMonitor<T>` | `configuration.IOptionsMonitor[T]` |
| `IOptionsSnapshot<T>` | 直接注入 `T`（快照） |
| `IOptions<T>` | 直接注入 `T` |
| `services.AddOptions<T>().Validate(...)` | `configuration.ConfigureWithValidation[T](...)` |

## 总结

`Configure[T]` 模式是 CSGO 配置管理的最佳实践：

- ✅ **简单** - 一行代码搞定
- ✅ **强大** - 类型安全 + 热更新
- ✅ **优雅** - .NET 风格的 API 设计
- ✅ **灵活** - 支持多种使用方式
- ✅ **可靠** - 生产级特性

**强烈推荐在所有项目中使用！**

