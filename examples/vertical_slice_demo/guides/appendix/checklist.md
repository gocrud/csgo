# 检查清单

本文档提供开发和代码审查时的检查清单，确保代码符合架构规范。

---

## 📋 新建功能检查清单

### 阶段1：规划阶段

- [ ] **确定功能复杂度**
  - [ ] 估算代码量（< 200 行？200-1000 行？> 1000 行？）
  - [ ] 选择合适的组织模式（模式1/2/3）
  - [ ] 确定是否需要 internal 目录

- [ ] **确定共享范围**
  - [ ] 是否需要跨端共享？→ 考虑 `shared/`
  - [ ] 是否需要应用内共享？→ 考虑 `apps/*/internal/`
  - [ ] 是否只在功能内使用？→ 保留在 `features/*/`

- [ ] **规划目录结构**
  - [ ] 确定功能目录名称（小写+下划线）
  - [ ] 确定需要创建的文件列表
  - [ ] 确定 DTO 组织方式

---

### 阶段2：开发阶段

#### Domain 模型

- [ ] **模型位置正确**
  - [ ] 跨端共享实体放在 `shared/domain/`
  - [ ] 单端特有实体放在 `apps/*/features/*/models/`
  - [ ] 通用基础字段放在 `shared/domain/common/`
  - [ ] 功能内部实体放在 `features/*/internal/entity/`

- [ ] **模型设计规范**
  - [ ] 包含必需字段（ID, CreatedAt, UpdatedAt）
  - [ ] 敏感字段（Password, Salt）标记为 `json:"-"`
  - [ ] 使用正确的 gorm 标签
  - [ ] 字段命名符合规范（PascalCase）
  - [ ] 布尔字段使用 `Is` 前缀
  - [ ] 时间字段使用 `At` 后缀

#### DTO 设计

- [ ] **DTO 位置正确**
  - [ ] DTO < 3 个：放在操作文件中
  - [ ] DTO 3-10 个：使用 `models.go`
  - [ ] DTO > 10 个：使用 `requests/` + `responses/`
  - [ ] 跨端共享：考虑 `shared/contracts/dtos/`

- [ ] **DTO 设计规范**
  - [ ] 命名清晰（CreateXxxRequest, XxxResponse）
  - [ ] 不包含敏感字段
  - [ ] 使用 `json` 标签
  - [ ] Request 使用 `binding` 标签进行验证
  - [ ] 提供转换函数（Domain ↔ DTO）

#### 代码组织

- [ ] **文件命名规范**
  - [ ] Handler: `{动词}_{名词}.go`（如 `create_user.go`）
  - [ ] Handler 函数: `{动词}{名词}Handler`（如 `CreateUserHandler`）
  - [ ] Controller: `controller.go`
  - [ ] Models: `models.go`
  - [ ] DI 注册: `service_extensions.go`

- [ ] **目录结构正确**
  - [ ] 模式1：`handler.go` + `service_extensions.go`
  - [ ] 模式2：`models.go` + `{operation}.go` + `controller.go`
  - [ ] 模式3：`internal/` + handlers + `controller.go`

- [ ] **internal 使用正确**
  - [ ] DTO 放在 internal 外面
  - [ ] Handler 放在 internal 外面
  - [ ] 内部实现放在 internal 里面
  - [ ] 功能内部分层使用 `features/*/internal/`
  - [ ] 应用级共享使用 `apps/*/internal/`

#### DI 注册

- [ ] **service_extensions.go 正确**
  - [ ] 函数命名：`Add{Feature}Feature`
  - [ ] 正确注册所有依赖
  - [ ] 注册顺序正确（依赖在前）
  - [ ] 使用正确的生命周期（Singleton/Scoped/Transient）

#### 路由映射

- [ ] **controller.go 正确**
  - [ ] Controller 命名：`{名词}Controller`
  - [ ] 实现 `MapRoutes` 方法
  - [ ] 路由路径规范（RESTful）
  - [ ] HTTP 方法正确（GET/POST/PUT/DELETE）

---

### 阶段3：测试阶段

- [ ] **功能测试**
  - [ ] 所有 API 端点可访问
  - [ ] 输入验证正常工作
  - [ ] 错误处理正确
  - [ ] 返回格式符合预期

- [ ] **边界测试**
  - [ ] 必填字段验证
  - [ ] 字段长度限制
  - [ ] 数据类型验证
  - [ ] 业务规则验证

---

## 🔍 代码审查检查清单

### 架构层面

- [ ] **代码位置正确**
  - [ ] 没有过早抽象到 `shared/`
  - [ ] 共享代码放在正确的位置
  - [ ] internal 使用正确
  - [ ] 目录结构符合规范

- [ ] **职责分离**
  - [ ] Handler 只处理 HTTP 请求/响应
  - [ ] 业务逻辑在 Service 或 Business 层
  - [ ] 数据访问在 Repository 或 Store 层
  - [ ] Domain 模型不包含业务逻辑

- [ ] **依赖方向正确**
  - [ ] Handler → Service/Business → Repository/Store
  - [ ] DTO 不依赖 Domain
  - [ ] 无循环依赖
  - [ ] internal 包只被父目录使用

### 代码质量

- [ ] **命名规范**
  - [ ] 文件名小写+下划线
  - [ ] 类型名 PascalCase
  - [ ] 函数名 PascalCase（导出）或 camelCase（私有）
  - [ ] 变量名 camelCase
  - [ ] 常量名 PascalCase 或 UPPER_SNAKE_CASE

- [ ] **代码风格**
  - [ ] 符合 Go 语言规范
  - [ ] 使用 gofmt 格式化
  - [ ] 没有无用的导入
  - [ ] 错误处理完整
  - [ ] 注释充分

- [ ] **安全性**
  - [ ] 敏感信息不在 DTO 中暴露
  - [ ] 密码经过哈希处理
  - [ ] 使用参数化查询（防 SQL 注入）
  - [ ] 输入验证完整
  - [ ] 权限检查正确

### Domain 模型

- [ ] **模型设计**
  - [ ] 包含必需字段
  - [ ] 字段类型正确
  - [ ] gorm 标签正确
  - [ ] 关联关系正确
  - [ ] 没有循环依赖

- [ ] **敏感字段处理**
  - [ ] Password 标记为 `json:"-"`
  - [ ] Salt 不暴露
  - [ ] 敏感字段不在日志中输出

### DTO 设计

- [ ] **DTO 规范**
  - [ ] 命名清晰
  - [ ] 不包含敏感字段
  - [ ] json 标签正确
  - [ ] binding 标签完整
  - [ ] 有转换函数

- [ ] **API 一致性**
  - [ ] 跨端 Response 格式一致（如需要）
  - [ ] 字段命名一致
  - [ ] 错误格式统一
  - [ ] 分页格式统一

### 功能实现

- [ ] **CRUD 完整性**
  - [ ] Create 操作正确
  - [ ] Read 操作正确
  - [ ] Update 操作正确
  - [ ] Delete 操作正确（软删除/硬删除）

- [ ] **错误处理**
  - [ ] 所有错误都有处理
  - [ ] 错误信息清晰
  - [ ] 使用统一的错误格式
  - [ ] 日志记录完整

- [ ] **验证规则**
  - [ ] 必填字段验证
  - [ ] 格式验证（邮箱、电话等）
  - [ ] 长度限制
  - [ ] 业务规则验证

---

## 🎨 重构检查清单

### 从模式1 → 模式2

- [ ] **触发条件**
  - [ ] 文件超过 200 行
  - [ ] 有 3 个以上操作
  - [ ] 团队有 2 人以上

- [ ] **重构步骤**
  - [ ] 创建 `models.go` 提取数据模型
  - [ ] 创建 `store.go` 提取数据访问（如需要）
  - [ ] 每个操作拆分到独立文件
  - [ ] 创建 `controller.go` 统一路由
  - [ ] 更新 `service_extensions.go`
  - [ ] 验证所有功能正常

### 从模式2 → 模式3

- [ ] **触发条件**
  - [ ] 文件总数超过 1000 行
  - [ ] 有复杂业务逻辑需要复用
  - [ ] 需要单独测试业务层

- [ ] **重构步骤**
  - [ ] 创建 `internal/entity/` 移动内部实体
  - [ ] 创建 `internal/data/` 移动数据访问
  - [ ] 创建 `internal/business/` 提取业务逻辑
  - [ ] Handler 只保留 HTTP 处理
  - [ ] 更新所有导入路径
  - [ ] 更新 `service_extensions.go`
  - [ ] 验证所有功能正常

### 从 features → shared

- [ ] **触发条件**
  - [ ] 第二个端也需要这个功能
  - [ ] 明确的跨端复用需求

- [ ] **重构步骤**
  - [ ] 移动 Domain 模型到 `shared/domain/`
  - [ ] 定义接口到 `shared/contracts/`
  - [ ] 移动实现到 `shared/repositories/` 或 `shared/services/`
  - [ ] 更新所有引用
  - [ ] 验证所有端正常工作

---

## 🚀 发布前检查清单

### 代码质量

- [ ] **静态检查**
  - [ ] go fmt 格式化
  - [ ] go vet 检查通过
  - [ ] golangci-lint 检查通过
  - [ ] 无编译警告

- [ ] **测试覆盖**
  - [ ] 单元测试通过
  - [ ] 集成测试通过
  - [ ] API 测试通过
  - [ ] 测试覆盖率 > 80%（可选）

### 文档

- [ ] **代码文档**
  - [ ] 导出函数有注释
  - [ ] 复杂逻辑有说明
  - [ ] README 更新（如需要）
  - [ ] API 文档更新（如需要）

### 性能

- [ ] **性能检查**
  - [ ] 无 N+1 查询
  - [ ] 使用合适的索引
  - [ ] 避免不必要的查询
  - [ ] 大列表使用分页

### 安全

- [ ] **安全检查**
  - [ ] 敏感信息不暴露
  - [ ] 权限检查完整
  - [ ] SQL 注入防护
  - [ ] XSS 防护（如适用）
  - [ ] CSRF 防护（如适用）

---

## 📊 性能优化检查清单

- [ ] **数据库查询**
  - [ ] 使用索引
  - [ ] 避免 SELECT *
  - [ ] 使用批量查询
  - [ ] 避免 N+1 问题
  - [ ] 使用事务（如需要）

- [ ] **缓存使用**
  - [ ] 热点数据缓存
  - [ ] 缓存失效策略
  - [ ] 避免缓存穿透
  - [ ] 避免缓存雪崩

- [ ] **并发处理**
  - [ ] 使用 goroutine 处理并发
  - [ ] 正确使用锁
  - [ ] 避免死锁
  - [ ] Context 超时设置

---

## 🔒 安全检查清单

- [ ] **认证授权**
  - [ ] 所有端点有权限检查
  - [ ] Token 验证正确
  - [ ] 权限级别正确
  - [ ] 敏感操作需要二次验证

- [ ] **数据安全**
  - [ ] 密码哈希存储
  - [ ] 敏感数据加密
  - [ ] 个人信息脱敏
  - [ ] 日志不包含敏感信息

- [ ] **输入验证**
  - [ ] 所有输入都验证
  - [ ] 使用白名单而非黑名单
  - [ ] 文件上传验证
  - [ ] 参数类型验证

---

## 📝 提交前检查清单

- [ ] **Git 提交**
  - [ ] 提交信息清晰
  - [ ] 不包含调试代码
  - [ ] 不包含敏感信息
  - [ ] 不包含大文件
  - [ ] 代码已格式化

- [ ] **分支管理**
  - [ ] 从正确的分支创建
  - [ ] 分支名称规范
  - [ ] 合并前拉取最新代码
  - [ ] 解决所有冲突

- [ ] **代码审查**
  - [ ] 自我审查通过
  - [ ] 同事审查通过（如需要）
  - [ ] 所有评论已处理
  - [ ] CI/CD 通过

---

## 🎯 快速自查表

### 我的代码放对位置了吗？

```
□ 跨端共享 → shared/
□ 应用内共享 → apps/*/internal/
□ 功能内复用 → features/*/internal/
□ 功能特有 → features/*/
```

### 我的 DTO 组织正确吗？

```
□ < 3 个 → 与操作一起
□ 3-10 个 → models.go
□ > 10 个 → requests/ + responses/
□ 跨端共享 → shared/contracts/dtos/
```

### 我的模型设计合理吗？

```
□ 包含必需字段
□ 敏感字段隐藏
□ 标签使用正确
□ 有转换函数
```

### 我的代码安全吗？

```
□ 敏感信息不暴露
□ 输入验证完整
□ 权限检查正确
□ 错误处理完善
```

---

## 📚 相关文档

- [项目结构组织](../01-project-structure.md)
- [Domain 模型组织](../02-domain-models.md)
- [DTO 模型组织](../03-dto-models.md)
- [internal 目录使用](../04-internal-directory.md)
- [共享策略指南](../05-sharing-strategies.md)
- [快速参考卡片](./quick-reference.md)
- [决策树汇总](./decision-trees.md)

---

**建议：** 打印此清单并在开发/审查时对照检查！
